# Virtual DOM

## 0. Определение

DOM - JS-объект, представляющий документ (HTML, XML) и набор API для работы с ним.

Virtual DOM - вспомогательный инструмент, _абстракция_ над DOM, которая позволяет __оптимально__ изменять DOM, когда что-либо происходит.

ReactDOM - библиотека, реализация Virtual DOM,
через декларативный API для attributes manipulation, event handling и manual DOM updates.

Под Virtual DOM мы будем понимать дерево React Element-ов - React DOM.

## 1. История и мотивация.

DOM:
- не был рассчитан на построение _динамических_ интерфейсов.
- не предоставляет __производительного__ способа обновлять _большое_ количество DOM-элементов.
- Библиотеки для работы с DOM (JQuery) ухудшают производительность и (чаще всего) архитектуру приложения.

Virtual DOM:
- Эффективные алгоритмы сравнения;
- Группировка операций чтения/записи при работе с DOM;
- Эффективное обновление только под-деревьев;


## 2. Reconciliation

- Функция `render()` объявляет дерево React Element-ов;
- Дерево помещается в соответствующее место в React DOM;
- В соответсвтии с React DOM, рисутеся DOM;
- При изменении state или props, функция `render()` вернет новое дерево React Element-ов;
- Это дерево заменит существующее в React DOM;
- DOM перерисовывается.

React нуждается в способе _наиболее эффективно_ обновлять DOM в соответсвии с изменениями в React DOM:
- 2 React Element-а _разных типов_ производят _разные деревья_;
- Различие списков производиться с использованием ключей (keys);

Алгоритм нахождения различий между 2 деревьями:

- сначала сравниваются 2 root React Element-а
- если __Element-ы(DOM, React)__ _разных_ типов, то:
  - React открепит старое дерево;
  - React удалит старые DOM элементы;
  - Весь state старых React Element-ов, будет удален;
  - React вызовет `componentWillUnmount()` для соответствующих старых React Element-ов;
  - React вызовет ~~`componentWillMount()`~~ и `componentDidMount()` для новых React Element-ов при их построении;
- если __DOM Element-ы__ _одинаковых_ типов:
  - React оставляет старое дерево;
  - если attributes изменились, React изменит _только их_;
- если __React Element-ы__ _одинаковых_ типов:
  - React оставляет старое дерево;
  - React обновляет props подэлемента;
  - React вызывает `componentWillReceiveProps()` и `componentWillUpdate()`;
Далее вызывается `render()` и алгоритм повторяется рекурсивно для children-ов.

Однако существует еще `shouldComponentUpdate()`;
